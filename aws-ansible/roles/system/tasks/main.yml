---

# general setup

- name: Verify Ansible meets Clojars version requirements.
  assert:
    that: "ansible_version.full is version_compare('2.9.4', '>=')"
    msg: >
      "You must update Ansible to at least 2.9.4 to deploy Clojars."

- name: Install EPEL for additional packages
  # sudo yum install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
  become: yes
  yum:
    name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
    state: present
      
- name: update yum caches
  become: yes
  yum:
    update_cache: yes
  
- name: Upgrade yum to the latest packages
  yum:
    name: '*'
    state: latest

- name: Install packages
  yum:
    name: "{{ al2_packages }}"
    state: latest

- name: set hostname
  hostname:
    name: "{{ hostname }}"

- name: set admin authorized_keys
  authorized_key:
    user: ec2-user
    key: "{{ item }}"
    state: present
  loop: "{{ ssh_keys }}"

- name: Copy cloudwatch-agent config
  become: yes
  become_user: root
  template:
    src: cloudwatch-agent-config.json.j2
    dest: /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.d/config.json
    mode: 0644

- name: Ensure cloudwatch-agent is enabled
  become: yes
  become_user: root
  service:
    name: amazon-cloudwatch-agent
    state: started
    enabled: yes
